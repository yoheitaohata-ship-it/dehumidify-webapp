<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>空気線図ツール</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    body {
      font-family: "Yu Gothic", "Meiryo", sans-serif;
      margin: 0;
      background: #f0f0f0;
    }

    header {
      background:#f5f5f5;
      padding:16px 20px;
      border-bottom:1px solid #ddd;
      text-align:center;
    }
    h1 {
      margin:0;
      font-size:22px;
    }

    /* ====== レイアウト ====== */
    .container {
      width:94%;
      max-width:480px;
      margin:0 auto;
      padding:12px 0;
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .grid {
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width:720px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .panel-input {
      background:#ffffff;
      padding:15px;
      border-radius:32px;
      border:1px solid #ddd;
      box-shadow:0 1px 3px rgba(0,0,0,0.05);
    }

    .panel-info {
      background:#e9e9e9;
      padding:15px;
      border-radius:32px;
      border:1px solid #d0d0d0;
      box-shadow:0 1px 3px rgba(0,0,0,0.03);
    }

    .panel-input h2,
    .panel-info h2 {
      margin-top:0;
      font-size:20px;
      border-bottom:1px solid:#ddd;
      padding-bottom:6px;
      margin-bottom:16px;
    }

    .row {
      margin-bottom:18px;
    }

    .row-2col {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    label {
      display:block;
      font-size:16px;
      margin-bottom:6px;
    }

    /* ===== 入力枠：青フォーカス ===== */
    input[type="number"] {
      width:100%;
      padding:9px 10px;
      font-size:19px;
      border:1px solid #99caff;
      border-radius:24px;
      box-sizing:border-box;
      background:#ffffff;
    }
    input[type="number"]:focus {
      outline:none;
      border-color:#4da3ff;
      box-shadow:0 0 0 3px rgba(77,163,255,0.4);
    }

    /* ===== ボタン：青系 ===== */
    button {
      width:100%;
      padding:12px;
      font-size:19px;
      border-radius:24px;
      cursor:pointer;
      border:1px solid #4da3ff;
    }

    .btn-primary {
      background:#4da3ff;
      color:white;
      border-color:#1c8cff;
    }
    .btn-primary:hover {
      background:#1c8cff;
    }

    .btn-secondary {
      background:#eee;
      border-color:#bbb;
    }

    .buttons-area {
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      padding-top:10px;
    }

    /* ===== ステータス（青で太字・大きく） ===== */
    #status {
      color:#0066cc;
      font-size:18px;
      font-weight:bold;
      margin-top:10px;
    }

    pre {
      background:#f5f5f5;
      border:1px solid #dcdcdc;
      padding:18px;
      border-radius:24px;
      font-size:15px;
      white-space:pre-wrap;
    }

    #graph-panel {
      display:none;
      border-radius:32px;
    }
    #info-panel {
      display:none;
      border-radius:32px;
    }

    #graph {
      width:100%;
      height:500px;
      border-radius:24px;
      background:#ffffff;
    }
    @media (max-width:600px) {
      #graph {
        height:380px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>空気線図ツール</h1>
</header>

<div class="container">

  <!-- 吸込 & 冷却 -->
  <div class="grid">
    <div class="panel-input">
      <h2>吸込 空気条件</h2>
      <div class="row row-2col">
        <div>
          <label for="Tin">温度 T_in [℃]</label>
          <input type="number" id="Tin" step="0.1">
        </div>
        <div>
          <label for="phi_in">相対湿度 φ_in [%]</label>
          <input type="number" id="phi_in" step="0.1">
        </div>
      </div>
    </div>

    <div class="panel-input">
      <h2>冷却後 空気条件</h2>
      <div class="row row-2col">
        <div>
          <label for="Tout">温度 T_out [℃]</label>
          <input type="number" id="Tout" step="0.1">
        </div>
        <div>
          <label for="phi_out">相対湿度 φ_out [%]</label>
          <input type="number" id="phi_out" step="0.1">
        </div>
      </div>
    </div>
  </div>

  <!-- 風量 & 冷凍能力 + ボタン -->
  <div class="grid">
    <div class="panel-input">
      <h2>風量・冷凍能力</h2>
      <div class="row row-2col">
        <div>
          <label for="V">風量 V [m³/min]</label>
          <input type="number" id="V" step="0.1">
        </div>
        <div>
          <label for="Q">冷凍能力 Q [kW]</label>
          <input type="number" id="Q" step="0.1">
        </div>
      </div>
    </div>

    <div class="buttons-area">
      <div class="row row-2col">
        <button class="btn-primary" onclick="onPlot()">プロット</button>
        <button class="btn-secondary" onclick="onClear()">クリア</button>
      </div>
      <div id="status"></div>
    </div>
  </div>

  <!-- 情報パネル & グラフ -->
  <div class="grid">
    <div id="info-panel" class="panel-info">
      <h2>空気情報</h2>
      <strong>吸込</strong>
      <pre id="info_in">未計算</pre>
      <strong>冷却</strong>
      <pre id="info_out">未計算</pre>
      <strong>プロセス</strong>
      <pre id="info_proc">未計算</pre>
    </div>

    <div id="graph-panel" class="panel-info">
      <h2>空気線図</h2>
      <div id="graph"></div>
    </div>
  </div>
</div>

<script>
/* ===== ここから下は前回と同じ JS（省略なし） ===== */
/* ==============================
   定数と計算用関数（Python版に合わせた式）
============================== */
const p  = 101.325;
const R  = 0.287;
const ca = 1.006;
const cw = 1.86;
const hw = 2501;

function ps(T){
  return 0.61078 * Math.exp((17.27 * T) / (T + 237.3));
}
function calcX(phi, T){
  const pv = phi * ps(T);
  return 0.622 * pv / (p - pv);
}
function calcH(T, x){
  return ca * T + x * (hw + cw * T);
}
function calcV(T,x){
  return (R*(T+273.15)/p)*(1+1.6078*x);
}
function calcDewPoint(phi,T){
  if(phi<=0) return -273.15;
  const pv = phi * ps(T);
  const ln_pv = Math.log(pv / 0.61078);
  return (237.3 * ln_pv) / (17.27 - ln_pv);
}
function calcWetBulbTemperature(T,RH){
  return (
    T*Math.atan(0.151977*Math.sqrt(RH+8.313659)) +
    Math.atan(T+RH) -
    Math.atan(RH-1.676331) +
    0.00391838*Math.pow(RH,1.5)*Math.atan(0.023101*RH) -
    4.686035
  );
}
function calcSaturationDegree(T,x){
  const xs = calcX(1.0,T);
  return (x/xs*100);
}
function calcDiscomfortIndex(T,RH){
  return 0.81*T + 0.01*RH*(0.99*T -14.3) + 46.3;
}
function linspace(a,b,n){
  let arr=[]; let d=(b-a)/(n-1);
  for(let i=0;i<n;i++) arr.push(a+d*i);
  return arr;
}
function solveBisection(f,a,b,maxIter=80,tol=1e-4){
  let fa=f(a), fb=f(b);
  if(fa*fb>0) return null;
  for(let i=0;i<maxIter;i++){
    const m=(a+b)/2;
    const fm=f(m);
    if(Math.abs(fm)<tol) return m;
    if(fa*fm<=0){ b=m; fb=fm; } else { a=m; fa=fm; }
  }
  return (a+b)/2;
}

/* ==============================
   グラフ
============================== */
function drawChart(Tmin,Tmax,Tin,phi_in,Tout,phi_out){
  const T = linspace(Tmin,Tmax,300);
  const sat = T.map(t=>calcX(1,t));

  const traces=[];
  traces.push({x:T,y:sat,mode:"lines",line:{color:"black"},showlegend:false});
  for(let rh=10;rh<100;rh+=10){
    const xs=T.map(t=>calcX(rh/100,t));
    traces.push({x:T,y:xs,mode:"lines",line:{color:"gray"},opacity:0.6,showlegend:false});
  }

  let x_in=null, x_out=null;
  if(Tin!=null && phi_in!=null){
    x_in=calcX(phi_in/100,Tin);
    traces.push({
      x:[Tin],y:[x_in],mode:"markers+text",
      marker:{color:"blue",size:10},
      text:["吸込"],textposition:"top right",showlegend:false
    });
  }
  if(Tout!=null && phi_out!=null){
    x_out=calcX(phi_out/100,Tout);
    traces.push({
      x:[Tout],y:[x_out],mode:"markers+text",
      marker:{color:"red",size:10},
      text:["冷却"],textposition:"bottom right",showlegend:false
    });
  }

  if(x_in!=null && x_out!=null){
    traces.push({
      x:[Tin,Tout],y:[x_in,x_out],
      mode:"lines",line:{color:"purple",dash:"dash"},showlegend:false
    });
  }

  Plotly.newPlot("graph", traces,
    {
      xaxis:{title:"温度 T [℃]"},
      yaxis:{title:"絶対湿度 x [kg/kg(DA)]"},
      margin:{l:60,r:20,t:30,b:60},
      showlegend:false
    },
    {staticPlot:true,responsive:true,displayModeBar:false}
  );
}

/* ==============================
   入力
============================== */
function val(id){
  const v=document.getElementById(id).value;
  if(v==="") return null;
  return Number(v);
}

/* ==============================
   プロット
============================== */
function onPlot(){
  const Tin=val("Tin"), phi_in=val("phi_in");
  const Tout=val("Tout"), phi_out=val("phi_out");
  const V=val("V"), Q=val("Q");

  const infoInEl=document.getElementById("info_in");
  const infoOutEl=document.getElementById("info_out");
  const infoProcEl=document.getElementById("info_proc");
  const statusEl=document.getElementById("status");

  document.getElementById("graph-panel").style.display="block";
  document.getElementById("info-panel").style.display="block";

  const missingKeys=[];
  if(Tin==null) missingKeys.push("Tin");
  if(phi_in==null) missingKeys.push("phi_in");
  if(Tout==null) missingKeys.push("Tout");
  if(phi_out==null) missingKeys.push("phi_out");
  if(V==null) missingKeys.push("V");
  if(Q==null) missingKeys.push("Q");

  let x1=null,h1=null,v1=null,Tdp1=null,Twb1=null,pw1=null,mu1=null,di1=null;
  if(Tin!=null && phi_in!=null){
    const phi_ratio=phi_in/100;
    x1=calcX(phi_ratio,Tin);
    h1=calcH(Tin,x1);
    v1=calcV(Tin,x1);
    pw1=phi_ratio*ps(Tin);
    Tdp1=calcDewPoint(phi_ratio,Tin);
    Twb1=calcWetBulbTemperature(Tin,phi_in);
    mu1=calcSaturationDegree(Tin,x1);
    di1=calcDiscomfortIndex(Tin,phi_in);
  }

  let Tout_eff=Tout;
  let phi_out_eff=phi_out;

  const statusParts=[];

  /* ===== 冷却条件の逆算 ===== */
  if(missingKeys.length===1 && (missingKeys[0]==="Tout" || missingKeys[0]==="phi_out")){
    const miss=missingKeys[0];
    if(Tin!=null && phi_in!=null && V!=null && Q!=null){
      if(v1>0){
        const m_da=(V/60)/v1;
        const h2_target=h1 - Q/m_da;

        if(miss==="Tout"){
          const phi_ratio=phi_out/100;
          const fT=T=>calcH(T,calcX(phi_ratio,T))-h2_target;
          const Tsol=solveBisection(fT,-50,60);
          if(Tsol!=null){
            Tout_eff=Tsol;
            statusParts.push(`冷却温度は ${Tsol.toFixed(2)} ℃`);
          }
        }
        if(miss==="phi_out"){
          const fPhi=pr=>calcH(Tout,calcX(pr,Tout))-h2_target;
          const phisol=solveBisection(fPhi,0.0001,1.0);
          if(phisol!=null){
            phi_out_eff=phisol*100;
            statusParts.push(`冷却相対湿度は ${phi_out_eff.toFixed(2)} %`);
          }
        }
      }
    }
  }

  /* ===== 温度範囲 ===== */
  const Ts=[];
  if(Tin!=null) Ts.push(Tin);
  if(Tout_eff!=null) Ts.push(Tout_eff);
  let Tmin=-10, Tmax=40;
  if(Ts.length>0){
    Tmin=Math.min(...Ts)-5;
    Tmax=Math.max(...Ts)+5;
  }

  drawChart(Tmin,Tmax,Tin,phi_in,Tout_eff,phi_out_eff);

  /* ===== 吸込 ===== */
  let info1="未計算";
  if(x1!=null){
    info1=
      `乾球温度 T       = ${Tin.toFixed(1)} ℃\n`+
      `湿球温度 T_w     = ${Twb1.toFixed(1)} ℃\n`+
      `相対湿度 φ       = ${phi_in.toFixed(1)} %\n`+
      `絶対湿度 x       = ${x1.toFixed(5)} kg/kg(DA)\n`+
      `露点温度 T_dp    = ${Tdp1.toFixed(1)} ℃\n`+
      `水蒸気分圧 p_w   = ${pw1.toFixed(3)} kPa\n`+
      `飽和度 μ         = ${mu1.toFixed(1)} %\n`+
      `比容積 v         = ${v1.toFixed(4)} m³/kg\n`+
      `比エンタルピ h   = ${h1.toFixed(2)} kJ/kg\n`+
      `不快指数 DI      = ${di1.toFixed(1)}`;
  }
  infoInEl.textContent=info1;

  /* ===== 冷却 ===== */
  let info2="未計算";
  let x2=null,h2=null,v2=null;
  if(Tout_eff!=null && phi_out_eff!=null){
    const pr=phi_out_eff/100;
    x2=calcX(pr,Tout_eff);
    h2=calcH(Tout_eff,x2);
    v2=calcV(Tout_eff,x2);
    const pw2=pr*ps(Tout_eff);
    const Tdp2=calcDewPoint(pr,Tout_eff);
    const Twb2=calcWetBulbTemperature(Tout_eff,phi_out_eff);
    const mu2=calcSaturationDegree(Tout_eff,x2);
    const di2=calcDiscomfortIndex(Tout_eff,phi_out_eff);

    const tagT=(Tout==null)?"(逆算)":"";
    const tagP=(phi_out==null)?"(逆算)":"";

    info2=
      `乾球温度 T       = ${Tout_eff.toFixed(1)} ℃ ${tagT}\n`+
      `湿球温度 T_w     = ${Twb2.toFixed(1)} ℃\n`+
      `相対湿度 φ       = ${phi_out_eff.toFixed(1)} % ${tagP}\n`+
      `絶対湿度 x       = ${x2.toFixed(5)} kg/kg(DA)\n`+
      `露点温度 T_dp    = ${Tdp2.toFixed(1)} ℃\n`+
      `水蒸気分圧 p_w   = ${pw2.toFixed(3)} kPa\n`+
      `飽和度 μ         = ${mu2.toFixed(1)} %\n`+
      `比容積 v         = ${v2.toFixed(4)} m³/kg\n`+
      `比エンタルピ h   = ${h2.toFixed(2)} kJ/kg\n`+
      `不快指数 DI      = ${di2.toFixed(1)}`;
  }
  infoOutEl.textContent=info2;

  /* ===== プロセス: Δh だけ ===== */
  let proc="未計算";
  let delta_h=null;
  if(h1!=null && h2!=null){
    delta_h=h1-h2;
    proc=`エンタルピ差 Δh = ${delta_h.toFixed(2)} kJ/kg(DA)`;
  }
  infoProcEl.textContent=proc;

  /* ===== V or Q 逆算（表示は青い status のみ） ===== */
  if(delta_h!=null && v1>0){
    if(missingKeys.length===1 && missingKeys[0]==="V" && Q!=null){
      const m_da=Q/delta_h;
      const V_calc=m_da*v1*60;
      statusParts.push(`風量は ${V_calc.toFixed(2)} m³/min`);
    }
    if(missingKeys.length===1 && missingKeys[0]==="Q" && V!=null){
      const m_da=(V/60)/v1;
      const Q_calc=m_da*delta_h;
      statusParts.push(`冷凍能力は ${Q_calc.toFixed(2)} kW`);
    }
  }

  if(statusParts.length===0){
    statusEl.textContent="プロットしました。";
  } else {
    statusEl.textContent=statusParts.join("、");
  }
}

/* ==============================
   クリア
============================== */
function onClear(){
  ["Tin","phi_in","Tout","phi_out","V","Q"].forEach(id=>document.getElementById(id).value="");

  document.getElementById("info_in").textContent="未計算";
  document.getElementById("info_out").textContent="未計算";
  document.getElementById("info_proc").textContent="未計算";

  document.getElementById("status").textContent="クリアしました。";

  Plotly.purge("graph");
  document.getElementById("graph-panel").style.display="none";
  document.getElementById("info-panel").style.display="none";
}
</script>

</body>
</html>
