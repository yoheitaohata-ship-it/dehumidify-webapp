<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <!-- スマホでもPCでも幅に応じてレイアウトが変わるためのviewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>空気線図ツール</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    body {
      font-family: "Yu Gothic", "Meiryo", sans-serif;
      margin: 0;
      background: #f0f0f0;
    }

    header {
      background:#f5f5f5;
      padding:16px 20px;
      border-bottom:1px solid #ddd;
      text-align:center;
    }
    h1 {
      margin:0;
      font-size:22px;
    }

    /* ====== レイアウト ====== */
    .container {
      width:94%;
      max-width:480px;
      margin:0 auto;
      padding:12px 0;
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .grid {
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width:720px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .panel-input {
      background:#ffffff;
      padding:15px;
      border-radius:32px;
      border:1px solid #ddd;
      box-shadow:0 1px 3px rgba(0,0,0,0.05);
    }

    .panel-info {
      background:#e9e9e9;
      padding:15px;
      border-radius:32px;
      border:1px solid #d0d0d0;
      box-shadow:0 1px 3px rgba(0,0,0,0.03);
    }

    .panel-input h2,
    .panel-info h2 {
      margin-top:0;
      font-size:20px;
      border-bottom:1px solid #ddd;
      padding-bottom:6px;
      margin-bottom:16px;
    }

    .row {
      margin-bottom:18px;
    }

    .row-2col {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    label {
      display:block;
      font-size:16px;
      margin-bottom:6px;
    }

    input[type="number"] {
      width:100%;
      padding:9px 10px;
      font-size:19px;
      border:1px solid:#ccc;
      border-radius:24px;
      box-sizing:border-box;
      background:#ffffff;
    }
    input[type="number"]:focus {
      outline:none;
      border-color:#ff9ab0;
      box-shadow:0 0 0 3px rgba(255,155,176,0.3);
    }

    button {
      width:100%;
      padding:12px;
      font-size:19px;
      border-radius:24px;
      cursor:pointer;
      border:1px solid #ccc;
    }
    .btn-primary {
      background:#ffb6c1;
      border-color:#ff9ab0;
    }
    .btn-primary:hover {
      background:#ff9ab0;
    }
    .btn-secondary {
      background:#eee;
    }

    /* ボタン用：枠なし */
    .buttons-area {
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      padding-top:10px;
    }

    pre {
      background:#f5f5f5;
      border:1px solid #dcdcdc;
      padding:18px;
      border-radius:24px;
      font-size:15px;
      white-space:pre-wrap;
    }

    strong {
      font-size:16px;
    }

    #status {
      color:#c00;
      font-size:15px;
      margin-top:6px;
    }

    #graph-panel {
      display:none;
      border-radius:32px;
    }
    #info-panel {
      display:none;
      border-radius:32px;
    }

    #graph {
      width:100%;
      height:500px;
      border-radius:24px;
      background:#ffffff;
    }
    @media (max-width:600px) {
      #graph {
        height:380px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>空気線図ツール</h1>
</header>

<div class="container">

  <!-- 吸込 & 冷却 -->
  <div class="grid">
    <!-- 吸込 -->
    <div class="panel-input">
      <h2>吸込 空気条件</h2>

      <div class="row row-2col">
        <div>
          <label for="Tin">温度 T_in [℃]</label>
          <input type="number" id="Tin" step="0.1">
        </div>
        <div>
          <label for="phi_in">相対湿度 φ_in [%]</label>
          <input type="number" id="phi_in" step="0.1">
        </div>
      </div>
    </div>

    <!-- 冷却 -->
    <div class="panel-input">
      <h2>冷却後 空気条件</h2>

      <div class="row row-2col">
        <div>
          <label for="Tout">温度 T_out [℃]</label>
          <input type="number" id="Tout" step="0.1">
        </div>
        <div>
          <label for="phi_out">相対湿度 φ_out [%]</label>
          <input type="number" id="phi_out" step="0.1">
        </div>
      </div>
    </div>
  </div>

  <!-- 風量・冷凍能力 & ボタン（ボタンは枠なし） -->
  <div class="grid">
    <div class="panel-input">
      <h2>風量・冷凍能力</h2>

      <div class="row row-2col">
        <div>
          <label for="V">風量 V [m³/min]</label>
          <input type="number" id="V" step="0.1">
        </div>
        <div>
          <label for="Q">冷凍能力 Q [kW]</label>
          <input type="number" id="Q" step="0.1">
        </div>
      </div>
    </div>

    <div class="buttons-area">
      <div class="row row-2col">
        <div>
          <button class="btn-primary" onclick="onPlot()">プロット</button>
        </div>
        <div>
          <button class="btn-secondary" onclick="onClear()">クリア</button>
        </div>
      </div>
      <div id="status"></div>
    </div>
  </div>

  <!-- 空気情報 & グラフ（最初は非表示） -->
  <div class="grid">
    <!-- 空気情報 -->
    <div id="info-panel" class="panel-info">
      <h2>空気情報</h2>

      <strong>吸込</strong>
      <pre id="info_in">未計算</pre>

      <strong>冷却</strong>
      <pre id="info_out">未計算</pre>

      <strong>プロセス</strong>
      <pre id="info_proc">未計算</pre>
    </div>

    <!-- グラフ -->
    <div id="graph-panel" class="panel-info">
      <h2>空気線図</h2>
      <div id="graph"></div>
    </div>
  </div>

</div>

<script>
/* ==============================
   定数と計算用関数（Python版に合わせた式）
============================== */
const p  = 101.325;   // [kPa]
const R  = 0.287;     // [kJ/(kg·K)]
const ca = 1.006;     // [kJ/(kg·K)]
const cw = 1.86;      // [kJ/(kg·K)]
const hw = 2501;      // [kJ/kg]
const air_density = 1.2; // [kg/m3] （今は未使用だが定義のみ）

// 飽和水蒸気圧 [kPa]
function ps(T){
  return 0.61078 * Math.exp((17.27 * T) / (T + 237.3));
}

// mode: "relative"→相対湿度(0-1)、"absolute"→絶対湿度(kg/kg)
function calcX(phi, T, mode="relative"){
  if(mode === "absolute"){
    return phi;
  } else {
    const pv = phi * ps(T);
    return 0.622 * pv / (p - pv);
  }
}

// 比エンタルピ h [kJ/kg]
function calcH(T, x){
  return ca * T + x * (hw + cw * T);
}

// 比容積 v [m3/kg]
function calcV(T, x){
  return (R * (T + 273.15) / p) * (1 + 1.6078 * x);
}

// x から相対湿度を求める（今のところ未使用）
function calcPhi(T, x){
  return (x * p) / (ps(T) * (0.622 + x));
}

// 露点温度 [℃]（phi は 0〜1 の相対湿度）
function calcDewPoint(phi, T){
  if(phi <= 0) return -273.15;
  const pv = phi * ps(T);
  if(pv <= 0) return -273.15;
  const ln_pv = Math.log(pv / 0.61078);
  return (237.3 * ln_pv) / (17.27 - ln_pv);
}

// 湿球温度 [℃]（RH は ％）– Stull の近似式
function calcWetBulbTemperature(T, RH){
  return (
    T * Math.atan(0.151977 * Math.sqrt(RH + 8.313659)) +
    Math.atan(T + RH) -
    Math.atan(RH - 1.676331) +
    0.00391838 * Math.pow(RH, 1.5) * Math.atan(0.023101 * RH) -
    4.686035
  );
}

// 飽和度 μ [%]
function calcSaturationDegree(T, x){
  const x_s = calcX(1.0, T, "relative");
  return (x_s !== 0) ? (x / x_s * 100) : 0;
}

// 不快指数
function calcDiscomfortIndex(T, RH){
  return 0.81 * T + 0.01 * RH * (0.99 * T - 14.3) + 46.3;
}

// 補助：リスト生成
function linspace(a,b,n){
  const arr=[];
  if(n<=1){arr.push(a);return arr;}
  const d=(b-a)/(n-1);
  for(let i=0;i<n;i++) arr.push(a+d*i);
  return arr;
}

// 汎用：二分法
function solveBisection(f, a, b, maxIter=60, tol=1e-4){
  let fa = f(a);
  let fb = f(b);
  if(!isFinite(fa) || !isFinite(fb)) return null;
  if(fa*fb > 0){
    return null;
  }
  for(let i=0;i<maxIter;i++){
    const m = 0.5*(a+b);
    const fm = f(m);
    if(!isFinite(fm)) return null;
    if(Math.abs(fm) < tol || Math.abs(b-a) < tol){
      return m;
    }
    if(fa*fm <= 0){
      b = m;
      fb = fm;
    }else{
      a = m;
      fa = fm;
    }
  }
  return 0.5*(a+b);
}

/* ==============================
   グラフ描画（ズーム禁止・凡例なし）
============================== */
function drawChart(Tmin,Tmax,Tin,phi_in,Tout,phi_out){
  const T = linspace(Tmin, Tmax, 300);
  const sat = T.map(t => calcX(1, t));

  const traces=[{
    x:T, y:sat,
    mode:"lines",
    line:{color:"black"},
    showlegend:false
  }];

  for(let rh=10; rh<100; rh+=10){
    const xs = T.map(t => calcX(rh/100, t));
    traces.push({
      x:T, y:xs,
      mode:"lines",
      line:{color:"gray"},
      opacity:0.6,
      showlegend:false
    });
  }

  let x_in=null, x_out=null;

  if(Tin!=null && phi_in!=null){
    x_in = calcX(phi_in/100, Tin);
    traces.push({
      x:[Tin], y:[x_in],
      mode:"markers+text",
      marker:{color:"blue", size:10},
      text:["吸込"],
      textposition:"top right",
      showlegend:false
    });
  }

  if(Tout!=null && phi_out!=null){
    x_out = calcX(phi_out/100, Tout);
    traces.push({
      x:[Tout], y:[x_out],
      mode:"markers+text",
      marker:{color:"red", size:10},
      text:["冷却"],
      textposition:"bottom right",
      showlegend:false
    });
  }

  if(x_in!=null && x_out!=null){
    traces.push({
      x:[Tin,Tout],
      y:[x_in,x_out],
      mode:"lines",
      line:{color:"purple", dash:"dash"},
      showlegend:false
    });
  }

  const layout = {
    xaxis:{title:"温度 T [℃]"},
    yaxis:{title:"絶対湿度 x [kg/kg(DA)]"},
    margin:{l:60,r:20,t:30,b:60},
    showlegend:false
  };

  Plotly.newPlot("graph", traces, layout, {
    responsive:true,
    displayModeBar:false,
    scrollZoom:false,
    staticPlot:true
  });
}

/* ==============================
   入力取得
============================== */
function val(id){
  const v = document.getElementById(id).value;
  if(v==="") return null;
  const n = Number(v);
  return isNaN(n) ? null : n;
}

/* ==============================
   プロット
============================== */
function onPlot(){
  const Tin    = val("Tin");
  const phi_in = val("phi_in");
  const Tout   = val("Tout");
  const phi_out= val("phi_out");
  const V      = val("V");
  const Q      = val("Q");

  const infoInEl   = document.getElementById("info_in");
  const infoOutEl  = document.getElementById("info_out");
  const infoProcEl = document.getElementById("info_proc");
  const statusEl   = document.getElementById("status");

  // パネル表示開始
  document.getElementById("graph-panel").style.display = "block";
  document.getElementById("info-panel").style.display  = "block";

  const inputsMap = {
    Tin: Tin,
    phi_in: phi_in,
    Tout: Tout,
    phi_out: phi_out,
    V: V,
    Q: Q
  };
  const missingKeys = Object.keys(inputsMap).filter(k => inputsMap[k] === null);

  // ===== 吸込状態 =====
  let x1=null, h1=null, v1=null;
  let Tdp1=null, Twb1=null, pw1=null, mu1=null, di1=null;

  if(Tin!=null && phi_in!=null){
    const phi_ratio_in = phi_in/100;
    x1  = calcX(phi_ratio_in, Tin);
    h1  = calcH(Tin, x1);
    v1  = calcV(Tin, x1);
    pw1 = phi_ratio_in * ps(Tin);          // kPa
    Tdp1 = calcDewPoint(phi_ratio_in, Tin);
    Twb1 = calcWetBulbTemperature(Tin, phi_in);
    mu1  = calcSaturationDegree(Tin, x1);
    di1  = calcDiscomfortIndex(Tin, phi_in);
  }

  // ===== 冷却側の T_out / φ_out 逆算 =====
  let Tout_eff = Tout;
  let phi_out_eff = phi_out;
  let solvedMessages = [];

  if(missingKeys.length === 1 && (missingKeys[0] === "Tout" || missingKeys[0] === "phi_out")){
    const miss = missingKeys[0];

    const canSolve =
      Tin != null &&
      phi_in != null &&
      V != null &&
      Q != null &&
      ((miss === "Tout"   && phi_out != null) ||
       (miss === "phi_out" && Tout   != null));

    if(canSolve && h1 != null && v1 != null && v1 > 0){
      const m_da = (V/60) / v1; // kg/s
      if(m_da > 0){
        const h2_target = h1 - Q / m_da; // kJ/kg
        if(miss === "Tout"){
          const phi_ratio = phi_out / 100.0;
          const fT = T => calcH(T, calcX(phi_ratio, T)) - h2_target;
          const Tlow = -50;
          const Thigh = 60;
          const Tsol = solveBisection(fT, Tlow, Thigh, 80, 1e-4);
          if(Tsol !== null){
            Tout_eff = Tsol;
            solvedMessages.push(`冷却温度 T_out を逆算: T_out ≒ ${Tsol.toFixed(2)} ℃`);
          } else {
            solvedMessages.push("T_out を逆算できませんでした（条件範囲外）。");
          }
        } else if(miss === "phi_out"){
          const fPhi = phi_ratio => calcH(Tout, calcX(phi_ratio, Tout)) - h2_target;
          const plow = 0.0001;
          const phigh = 1.0;
          const phisol = solveBisection(fPhi, plow, phigh, 80, 1e-5);
          if(phisol !== null){
            const phi_percent = phisol*100.0;
            phi_out_eff = phi_percent;
            solvedMessages.push(`冷却相対湿度 φ_out を逆算: φ_out ≒ ${phi_percent.toFixed(2)} %`);
          } else {
            solvedMessages.push("φ_out を逆算できませんでした（条件範囲外）。");
          }
        }
      }
    } else if(missingKeys[0] === "Tout" || missingKeys[0] === "phi_out"){
      solvedMessages.push("T_out または φ_out の逆算には Tin, φ_in, V, Q と、もう片方の冷却条件が必要です。");
    }
  }

  // ===== 温度範囲決定 =====
  const Ts = [];
  if(Tin     != null) Ts.push(Tin);
  if(Tout_eff!= null) Ts.push(Tout_eff);

  let Tmin=-10, Tmax=40;
  if(Ts.length>0){
    Tmin = Math.min(...Ts) - 5;
    Tmax = Math.max(...Ts) + 5;
  }

  drawChart(Tmin, Tmax, Tin, phi_in, Tout_eff, phi_out_eff);

  // ===== 吸込情報テキスト =====
  let info1="未計算";
  if(Tin!=null && phi_in!=null && x1!=null && h1!=null && v1!=null){
    const Tdp1txt = (Tdp1!=null && Tdp1>-200) ? Tdp1.toFixed(1) : "―";
    const Twb1txt = (Twb1!=null) ? Twb1.toFixed(1) : "―";
    const pw1txt  = (pw1!=null)  ? pw1.toFixed(3) : "―";
    const mu1txt  = (mu1!=null)  ? mu1.toFixed(1) : "―";
    const di1txt  = (di1!=null)  ? di1.toFixed(1) : "―";

    info1 =
      `乾球温度 T       = ${Tin.toFixed(1)} ℃\n` +
      `湿球温度 T_w     = ${Twb1txt} ℃\n` +
      `相対湿度 φ       = ${phi_in.toFixed(1)} %\n` +
      `絶対湿度 x       = ${x1.toFixed(5)} kg/kg(DA)\n` +
      `露点温度 T_dp    = ${Tdp1txt} ℃\n` +
      `水蒸気分圧 p_w   = ${pw1txt} kPa\n` +
      `飽和度 μ         = ${mu1txt} %\n` +
      `比容積 v         = ${v1.toFixed(4)} m³/kg\n` +
      `比エンタルピ h   = ${h1.toFixed(2)} kJ/kg\n` +
      `不快指数 DI      = ${di1txt}`;
  }

  // ===== 冷却情報 =====
  let info2="未計算";
  let x2=null, h2=null, v2=null;
  let Tdp2=null, Twb2=null, pw2=null, mu2=null, di2=null;

  if(Tout_eff!=null && phi_out_eff!=null){
    const phi_ratio_out = phi_out_eff/100.0;
    x2  = calcX(phi_ratio_out, Tout_eff);
    h2  = calcH(Tout_eff, x2);
    v2  = calcV(Tout_eff, x2);
    pw2 = phi_ratio_out * ps(Tout_eff);
    Tdp2 = calcDewPoint(phi_ratio_out, Tout_eff);
    Twb2 = calcWetBulbTemperature(Tout_eff, phi_out_eff);
    mu2  = calcSaturationDegree(Tout_eff, x2);
    di2  = calcDiscomfortIndex(Tout_eff, phi_out_eff);

    const tagT  = (Tout === null)   ? "（逆算）" : "";
    const tagPh = (phi_out === null)? "（逆算）" : "";

    const Tdp2txt = (Tdp2!=null && Tdp2>-200) ? Tdp2.toFixed(1) : "―";
    const Twb2txt = (Twb2!=null) ? Twb2.toFixed(1) : "―";
    const pw2txt  = (pw2!=null)  ? pw2.toFixed(3) : "―";
    const mu2txt  = (mu2!=null)  ? mu2.toFixed(1) : "―";
    const di2txt  = (di2!=null)  ? di2.toFixed(1) : "―";

    info2 =
      `乾球温度 T       = ${Tout_eff.toFixed(1)} ℃ ${tagT}\n` +
      `湿球温度 T_w     = ${Twb2txt} ℃\n` +
      `相対湿度 φ       = ${phi_out_eff.toFixed(1)} % ${tagPh}\n` +
      `絶対湿度 x       = ${x2.toFixed(5)} kg/kg(DA)\n` +
      `露点温度 T_dp    = ${Tdp2txt} ℃\n` +
      `水蒸気分圧 p_w   = ${pw2txt} kPa\n` +
      `飽和度 μ         = ${mu2txt} %\n` +
      `比容積 v         = ${v2.toFixed(4)} m³/kg\n` +
      `比エンタルピ h   = ${h2.toFixed(2)} kJ/kg\n` +
      `不快指数 DI      = ${di2txt}`;
  }

  infoInEl.textContent  = info1;
  infoOutEl.textContent = info2;

  // ===== プロセス・V/Q の逆算 =====
  let procLines = [];

  let delta_h = null;
  if(h1!=null && h2!=null){
    delta_h = h1 - h2;
    procLines.push(`エンタルピ差 Δh = ${delta_h.toFixed(2)} kJ/kg(DA)`);
  } else {
    procLines.push("吸込・冷却の温度・湿度がそろうと Δh や V/Q の計算が可能です。");
  }

  if(solvedMessages.length > 0){
    procLines.push("");
    procLines.push("【冷却条件の逆算】");
    solvedMessages.forEach(msg => procLines.push(msg));
  }

  if(delta_h != null && v1 != null && v1 > 0){
    const missing = missingKeys;

    if(missing.length === 1 && (missing[0] === "V" || missing[0] === "Q")){
      const miss = missing[0];

      if(miss === "V" && Q != null){
        const m_da = Q / delta_h;
        const V_calc = m_da * v1 * 60;
        procLines.push("");
        procLines.push("【V の逆算】");
        procLines.push(`入力された冷凍能力 Q = ${Q.toFixed(2)} kW を得るために必要な風量:`);
        procLines.push(`  V ≒ ${V_calc.toFixed(2)} m³/min`);
      } else if(miss === "Q" && V != null){
        const V_s  = V / 60;
        const m_da = V_s / v1;
        const Q_calc = m_da * delta_h;
        procLines.push("");
        procLines.push("【Q の逆算】");
        procLines.push(`入力された風量 V = ${V.toFixed(2)} m³/min のときの冷凍能力:`);
        procLines.push(`  Q ≒ ${Q_calc.toFixed(2)} kW`);
      }
    } else {
      if(V != null){
        const V_s  = V / 60;
        const m_da = V_s / v1;
        const Q_calc = m_da * delta_h;
        procLines.push("");
        procLines.push(`風量 V = ${V.toFixed(2)} m³/min のとき:`);
        procLines.push(`  冷凍能力 Q ≒ ${Q_calc.toFixed(2)} kW`);
        if(Q != null){
          procLines.push(`（参考）入力された Q = ${Q.toFixed(2)} kW`);
        }
      } else if(Q != null){
        procLines.push("");
        procLines.push("冷凍能力 Q は入力されていますが、風量 V が未入力です。");
        procLines.push("※ V を空のまま他5項目を埋めれば、Q から V を逆算します。");
      }
    }
  } else {
    procLines.push("");
    procLines.push("※ V/Q または冷却条件の逆算には、吸込状態と冷却状態が必要です。");
  }

  infoProcEl.textContent = procLines.join("\n");
  statusEl.textContent   = "プロットしました。";
}

/* ==============================
   クリア
============================== */
function onClear(){
  ["Tin","phi_in","Tout","phi_out","V","Q"]
    .forEach(id => document.getElementById(id).value = "");

  document.getElementById("info_in").textContent   = "未計算";
  document.getElementById("info_out").textContent  = "未計算";
  document.getElementById("info_proc").textContent = "未計算";

  document.getElementById("status").textContent    = "クリアしました。";

  Plotly.purge("graph");
  document.getElementById("graph-panel").style.display = "none";
  document.getElementById("info-panel").style.display  = "none";
}
</script>

</body>
</html>
