<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>除湿能力 計算（軽量版・グラフなし）</title>
  <style>
    :root { --fg:#222; --muted:#666; --accent:#0a7; --err:#c22; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
           margin: 0; color: var(--fg); background:#fafafa; }
    header { padding: 16px 20px; background:#fff; border-bottom:1px solid #eee; position: sticky; top:0; }
    header h1 { font-size: 18px; margin: 0; }
    main { padding: 16px; max-width: 900px; margin: 0 auto; }
    .card { background:#fff; border:1px solid #eee; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 660px) { .grid { grid-template-columns: 1fr; } }
    label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 4px; }
    input[type="number"] { width:100%; box-sizing:border-box; padding:10px 12px; border-radius:10px; border:1px solid #ddd; font-size:16px; }
    .row { display:flex; gap:10px; align-items:center; }
    .unit { white-space:nowrap; color:#555; font-size: 14px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
    button { appearance:none; border:none; border-radius: 12px; padding: 12px 16px; font-size: 16px; cursor:pointer; }
    .primary { background: var(--accent); color: #fff; }
    .secondary { background:#eee; color:#333; }
    .msg { margin: 8px 0; font-size:14px; }
    .msg.ok { color: var(--accent); }
    .msg.err { color: var(--err); }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid #eee; text-align: right; }
    th:nth-child(1), td:nth-child(1) { text-align:left; }
    footer { padding: 24px; text-align:center; color:#888; font-size:13px; }
  </style>
</head>
<body>
  <header>
    <h1>除湿能力 計算（軽量・グラフ無し）</h1>
  </header>

  <main>
    <section class="card">
      <h2 style="margin:0 0 12px 0; font-size:16px;">入力</h2>
      <div class="grid">
        <!-- 吸込 -->
        <div>
          <label>吸込 乾球温度</label>
          <div class="row">
            <input id="T_in" type="number" step="0.1" placeholder="例: 27.0" />
            <span class="unit">°C(DB)</span>
          </div>
        </div>
        <div>
          <label>吸込 相対湿度</label>
          <div class="row">
            <input id="RH_in" type="number" step="0.1" placeholder="例: 50" />
            <span class="unit">%RH</span>
          </div>
        </div>

        <!-- 冷却後 -->
        <div>
          <label>冷却後 乾球温度</label>
          <div class="row">
            <input id="T_out" type="number" step="0.1" placeholder="例: 14.0" />
            <span class="unit">°C(DB)</span>
          </div>
        </div>
        <div>
          <label>冷却後 相対湿度</label>
          <div class="row">
            <input id="RH_out" type="number" step="0.1" placeholder="例: 95" />
            <span class="unit">%RH</span>
          </div>
        </div>

        <!-- どちらか一方でOK -->
        <div>
          <label>風量（どちらか一方でOK）</label>
          <div class="row">
            <input id="V" type="number" step="0.1" placeholder="例: 20.0" />
            <span class="unit">m³/min</span>
          </div>
        </div>
        <div>
          <label>冷却能力（どちらか一方でOK）</label>
          <div class="row">
            <input id="Q" type="number" step="0.1" placeholder="例: 未入力でも可" />
            <span class="unit">kW</span>
          </div>
        </div>
      </div>

      <div class="actions" style="margin-top:14px;">
        <button id="calc" class="primary">計算</button>
        <button id="clear" class="secondary">クリア</button>
      </div>
      <div id="msg" class="msg"></div>
    </section>

    <section id="resultsCard" class="card" style="display:none;">
      <h2 style="margin:0 0 12px 0; font-size:16px;">計算結果</h2>
      <table>
        <tbody>
          <tr><th>風量 V</th><td><span id="rV">-</span></td><td class="unit">m³/min</td></tr>
          <tr><th>冷却能力 Q</th><td><span id="rQ">-</span></td><td class="unit">kW</td></tr>
          <tr><th>除湿量</th><td><span id="rL">-</span></td><td class="unit">L/h</td></tr>
          <tr><th>質量流量 ṁ</th><td><span id="rm">-</span></td><td class="unit">kg/s</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <footer>© Dehumidify Calculator (Static HTML/JS)</footer>

  <script>
    // --- 物性定数（kJ 系）---
    const P_ATM = 101.325; // kPa
    const R_AIR = 0.287;   // kJ/(kg·K)
    const C_A   = 1.006;   // kJ/(kg·K)
    const C_W   = 1.86;    // kJ/(kg·K)
    const H_W   = 2501.0;  // kJ/kg

    // 飽和水蒸気圧（Tetens近似, kPa）
    function ps(Tc){
      return 0.61078 * Math.exp((17.27 * Tc) / (Tc + 237.3));
    }

    // 相対湿度(0-1) → 絶対湿度 x[kg/kg(DA)]
    function x_from_phi(phi, Tc){
      const pv = phi * ps(Tc); // kPa
      return 0.622 * pv / (P_ATM - pv);
    }

    // 比エンタルピ h [kJ/kg(DA)]
    function h_moist_air(Tc, x){
      return C_A*Tc + x*(H_W + C_W*Tc);
    }

    // 比容 v [m^3/kg(DA)]
    function v_specific(Tc, x){
      return (R_AIR * (Tc + 273.15) / P_ATM) * (1 + 1.6078 * x);
    }

    function fnum(s){
      if (s === null || s === undefined || s === "") return null;
      const v = Number(s);
      return Number.isFinite(v) ? v : null;
    }

    function fmt(x, n=1){
      return (x===null || !Number.isFinite(x)) ? "-" : x.toFixed(n);
    }

    function compute(){
      const msg = document.getElementById("msg");
      const card = document.getElementById("resultsCard");
      msg.textContent = "";
      msg.className = "msg";

      // 入力取得
      const T_in  = fnum(document.getElementById("T_in").value);
      const RH_in = fnum(document.getElementById("RH_in").value);
      const T_o   = fnum(document.getElementById("T_out").value);
      const RH_o  = fnum(document.getElementById("RH_out").value);
      let   V_in  = fnum(document.getElementById("V").value);  // m^3/min（任意）
      let   Q_in  = fnum(document.getElementById("Q").value);  // kW（任意）

      // 必須チェック
      if ([T_in,RH_in,T_o,RH_o].some(v => v===null)){
        msg.textContent = "吸込T/φ・冷却T/φは必須です。";
        msg.classList.add("err");
        card.style.display = "none";
        return;
      }
      if (V_in===null && Q_in===null){
        msg.textContent = "風量 V または 冷却能力 Q のどちらかを入力してください。";
        msg.classList.add("err");
        card.style.display = "none";
        return;
      }

      // 物性（吸込側）
      const phi_in = RH_in/100.0;
      const x_in   = x_from_phi(phi_in, T_in);
      const h_in   = h_moist_air(T_in, x_in);
      const v_in   = v_specific(T_in, x_in);

      // 物性（冷却後）
      const phi_o = RH_o/100.0;
      const x_o   = x_from_phi(phi_o, T_o);
      const h_o   = h_moist_air(T_o, x_o);

      // 連成：ṁ, Q, V
      let m_dot = null;
      let Q = Q_in;
      let V = V_in;

      // Vがある → m_dot 先に確定
      if (V !== null){
        m_dot = (V / 60.0) / v_in; // kg/s
      }

      // Qが空なら計算
      if (Q === null){
        if (m_dot === null){
          msg.textContent = "内部エラー: m_dot 未定義（Vを入れるか、Qを直接入力してください）";
          msg.classList.add("err");
          card.style.display = "none";
          return;
        }
        Q = m_dot * (h_in - h_o); // kW
      }

      // Vが空なら Qから逆算
      if (V === null){
        const dh = (h_in - h_o);
        if (Math.abs(dh) < 1e-12){
          msg.textContent = "状態が等しいため V を逆算できません（Δh ≈ 0）。";
          msg.classList.add("err");
          card.style.display = "none";
          return;
        }
        m_dot = Q / dh;
        V = m_dot * 60.0 * v_in; // m^3/min
      }

      // 除湿量 [kg/h ≒ L/h]
      const L_Lph = (x_in - x_o) * m_dot * 3600.0;

      // 表示
      document.getElementById("rV").textContent  = fmt(V, 1);
      document.getElementById("rQ").textContent  = fmt(Q, 1);
      document.getElementById("rL").textContent  = fmt(L_Lph, 1);
      document.getElementById("rm").textContent  = fmt(m_dot, 4);

      card.style.display = "block";
      msg.textContent = "計算しました。";
      msg.classList.add("ok");
    }

    function clearAll(){
      ["T_in","RH_in","T_out","RH_out","V","Q"].forEach(id => {
        document.getElementById(id).value = "";
      });
      document.getElementById("resultsCard").style.display = "none";
      const msg = document.getElementById("msg");
      msg.textContent = "";
      msg.className = "msg";
    }

    document.getElementById("calc").addEventListener("click", compute);
    document.getElementById("clear").addEventListener("click", clearAll);

    // Enterキーで計算
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") compute();
    });
  </script>
</body>
</html>
