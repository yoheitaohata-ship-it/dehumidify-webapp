<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>空気線図計算</title>
<style>
  :root { --fg:#111; --muted:#666; --bg:#fff; --card:#f6f7f9; --accent:#2266ff; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; color:var(--fg); background:var(--bg); }
  header { padding:16px 20px; border-bottom:1px solid #e5e7eb; background:#fff; position:sticky; top:0; z-index:10; }
  header h1 { margin:0; font-size:18px; }
  main { max-width:960px; margin:0 auto; padding:16px; }
  .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
  @media (min-width:720px){ .grid { grid-template-columns: 1fr 1fr; } }
  .card { background:var(--card); border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
  .card h2, .card h3 { margin:4px 0 10px; font-size:16px; }
  .row { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; margin-bottom:8px; }
  .row label { display:block; font-size:13px; color:var(--muted); }
  input[type="number"] { width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; }
  .actions { display:flex; gap:8px; margin:10px 0; }
  button { cursor:pointer; padding:10px 14px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; font-weight:600; }
  button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
  #msg { margin:8px 0; color:#065f46; font-weight:600; min-height:1.5em; white-space:pre-line; }
  .result { display:none; }
  .result h3 { margin:6px 0 6px; font-size:15px; }
  .kvs { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  .kv { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; }
  .kv .k { font-size:12px; color:var(--muted); margin-bottom:4px; }
  .kv .v { font-variant-numeric: tabular-nums; font-weight:600; }
  footer { margin:30px 0 10px; text-align:center; color:#9ca3af; font-size:12px; }
</style>
</head>
<body>
  <header>
    <h1>空気線図計算</h1>
  </header>

  <main>
    <div class="card">
      <h2>入力</h2>
      <div class="grid">
        <div class="card">
          <h3>吸込（入口）</h3>
          <div class="row">
            <div>
              <label>乾球温度 T<sub>in</sub> [°C]</label>
              <input id="T_in" type="number" inputmode="decimal" />
            </div>
            <div>
              <label>相対湿度 RH<sub>in</sub> [%]</label>
              <input id="RH_in" type="number" inputmode="decimal" />
            </div>
          </div>
        </div>
        <div class="card">
          <h3>冷却（出口）</h3>
          <div class="row">
            <div>
              <label>乾球温度 T<sub>out</sub> [°C]</label>
              <input id="T_out" type="number" inputmode="decimal" />
            </div>
            <div>
              <label>相対湿度RH<sub>out</sub>[%]</label>
              <input id="RH_out" type="number" inputmode="decimal" />
            </div>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:8px;">
        <div class="card">
          <h3>任意入力（どちらか一方でOK）</h3>
          <div class="row">
            <div>
              <label>風量 V [m³/min]</label>
              <input id="V" type="number" inputmode="decimal" />
            </div>
            <div>
              <label>冷却能力 Q [kW]</label>
              <input id="Q" type="number" inputmode="decimal" />
            </div>
          </div>
          <div class="actions">
            <button id="calc" class="primary">計算する</button>
            <button id="clear">クリア</button>
          </div>
          <div id="msg"></div>
        </div>

        <div class="card">
          <h3>主な結果</h3>
          <div class="kvs">
            <div class="kv"><div class="k">風量 V [m³/min]</div><div class="v" id="rV">-</div></div>
            <div class="kv"><div class="k">冷却能力 Q [kW]</div><div class="v" id="rQ">-</div></div>
            <div class="kv"><div class="k">除湿量 L [L/h]</div><div class="v" id="rL">-</div></div>
            <div class="kv"><div class="k">質量流量 ṁ [kg/s]</div><div class="v" id="rm">-</div></div>
          </div>
        </div>
      </div>
    </div>

    <div id="results" class="result" style="margin-top:12px;">
      <div class="grid">
        <div class="card">
          <h2>吸込空気 情報</h2>
          <div class="kvs">
            <div class="kv"><div class="k">乾球温度 [°C]</div><div class="v" id="in_T">-</div></div>
            <div class="kv"><div class="k">湿球温度(近似) [°C]</div><div class="v" id="in_Tw">-</div></div>
            <div class="kv"><div class="k">相対湿度 [%]</div><div class="v" id="in_RH">-</div></div>
            <div class="kv"><div class="k">絶対湿度 x [g/kg(DA)]</div><div class="v" id="in_x">-</div></div>
            <div class="kv"><div class="k">露点温度 [°C]</div><div class="v" id="in_Td">-</div></div>
            <div class="kv"><div class="k">水蒸気分圧 pv [Pa]</div><div class="v" id="in_pv">-</div></div>
            <div class="kv"><div class="k">比容 v [m³/kg]</div><div class="v" id="in_v">-</div></div>
            <div class="kv"><div class="k">比エンタルピ h [kJ/kg]</div><div class="v" id="in_h">-</div></div>
            <div class="kv"><div class="k">飽和度 μ [%]</div><div class="v" id="in_mu">-</div></div>
            <div class="kv"><div class="k">不快指数 DI</div><div class="v" id="in_DI">-</div></div>
          </div>
        </div>

        <div class="card">
          <h2>冷却空気 情報</h2>
          <div class="kvs">
            <div class="kv"><div class="k">乾球温度 [°C]</div><div class="v" id="out_T">-</div></div>
            <div class="kv"><div class="k">湿球温度(近似) [°C]</div><div class="v" id="out_Tw">-</div></div>
            <div class="kv"><div class="k">相対湿度 [%]</div><div class="v" id="out_RH">-</div></div>
            <div class="kv"><div class="k">絶対湿度 x [g/kg(DA)]</div><div class="v" id="out_x">-</div></div>
            <div class="kv"><div class="k">露点温度 [°C]</div><div class="v" id="out_Td">-</div></div>
            <div class="kv"><div class="k">水蒸気分圧 pv [Pa]</div><div class="v" id="out_pv">-</div></div>
            <div class="kv"><div class="k">比容 v [m³/kg]</div><div class="v" id="out_v">-</div></div>
            <div class="kv"><div class="k">比エンタルピ h [kJ/kg]</div><div class="v" id="out_h">-</div></div>
            <div class="kv"><div class="k">飽和度 μ [%]</div><div class="v" id="out_mu">-</div></div>
            <div class="kv"><div class="k">不快指数 DI</div><div class="v" id="out_DI">-</div></div>
          </div>
        </div>
      </div>
    </div>

    <footer>© Dehumidify Lite</footer>
  </main>

<script>
/* ---- 定数（kJ系） ---- */
const P_ATM = 101.325;   // kPa
const R_AIR = 0.287;     // kJ/(kg·K)
const C_A   = 1.006;     // kJ/(kg·K)
const C_W   = 1.86;      // kJ/(kg·K)
const H_W   = 2501.0;    // kJ/kg

/* --- 基本式 --- */
function ps(Tc){ return 0.61078 * Math.exp((17.27*Tc)/(Tc+237.3)); } // kPa

function x_from_phi(phi, Tc){
  const ph = Math.max(0.001, Math.min(0.999, phi));
  const pv = ph * ps(Tc);                   // kPa
  return 0.622 * pv / (P_ATM - pv);         // kg/kg(DA)
}

function phi_from_x_T(x, Tc){
  const xx = Math.max(1e-9, x);
  const pv = (xx * P_ATM) / (0.622 + xx);   // kPa
  return Math.max(0.0, Math.min(1.0, pv / ps(Tc)));
}

function h_moist_air(Tc, x){ return C_A*Tc + x*(H_W + C_W*Tc); }   // kJ/kg
function v_specific(Tc, x){ return (R_AIR*(Tc+273.15)/P_ATM)*(1+1.6078*x); } // m^3/kg

function dew_point(phi, Tc){
  const ph = Math.max(0.001, Math.min(0.999, phi));
  const y = Math.log((ph*ps(Tc)) / 0.61078);
  return (237.3 * y) / (17.27 - y);
}

function wet_bulb_stull(Tc, RH){
  const rh = Math.max(0, Math.min(100, RH));
  return Tc * Math.atan(0.151977*Math.sqrt(rh+8.313659))
       + Math.atan(Tc + rh) - Math.atan(rh - 1.676331)
       + 0.00391838*Math.pow(rh,1.5)*Math.atan(0.023101*rh) - 4.686035;
}

function saturation_degree(Tc, x){ return (x/x_from_phi(1.0, Tc))*100; }
function discomfort_index(Tc, RH){ return 0.81*Tc + 0.01*RH*(0.99*Tc - 14.3) + 46.3; }

function fnum(raw){
  if (raw == null) return null;
  let t = String(raw).trim();
  if (t === "") return null;              // ← 空は null（未入力）
  t = toHalfWidthDigits(t);               // ← 全角数字を半角に
  t = t.replace(/,/g, ".");               // ← 1,5 → 1.5
  const v = Number(t);
  return Number.isFinite(v) ? v : null;   // ← 数値化できなければ null
}function fmt(x,n=1){ return (x==null||!Number.isFinite(x))? "-": x.toFixed(n); }

function airProps(Tc, RHpct){
  if (Tc==null || RHpct==null) return null;
  const phi = Math.max(0.001, Math.min(0.999, RHpct/100.0));
  const x = x_from_phi(phi, Tc);
  const h = h_moist_air(Tc, x);
  const v = v_specific(Tc, x);
  const Td = dew_point(phi, Tc);
  const Tw = wet_bulb_stull(Tc, RHpct);
  const pv = phi*ps(Tc)*1000.0; // Pa
  const mu = saturation_degree(Tc, x);
  const DI = discomfort_index(Tc, RHpct);
  return { Tc, RH:RHpct, x, h, v, Td, Tw, pv, mu, DI };
}

/* --- 汎用2分法（符号反転区間を自動スキャン） --- */
function solve_bisect(f, a, b, tol=1e-6, maxit=80){
  let fa=f(a), fb=f(b);
  if (!Number.isFinite(fa) || !Number.isFinite(fb)) return null;
  if (fa*fb>0){
    const N=60; let left=a, fleft=fa;
    for(let i=1;i<=N;i++){
      const right=a+(b-a)*i/N, fright=f(right);
      if(!Number.isFinite(fright)) return null;
      if (fleft*fright<=0){ a=left; b=right; fa=fleft; fb=fright; break; }
      left=right; fleft=fright;
    }
    if (fa*fb>0) return null;
  }
  for(let i=0;i<maxit;i++){
    const m=0.5*(a+b), fm=f(m);
    if(!Number.isFinite(fm)) return null;
    if(Math.abs(fm)<tol||Math.abs(b-a)<tol) return m;
    if(fa*fm<=0){ b=m; fb=fm; } else { a=m; fa=fm; }
  }
  return 0.5*(a+b);
}

/* ---- UI反映 ---- */
function fillState(prefix, P){
  const ids = ["T","Tw","RH","x","Td","pv","v","h","mu","DI"];
  if(!P){ ids.forEach(k=>{ const el=document.getElementById(`${prefix}_${k}`); if(el) el.textContent="-"; }); return; }
  document.getElementById(`${prefix}_T`).textContent  = fmt(P.Tc, 1);
  document.getElementById(`${prefix}_Tw`).textContent = fmt(P.Tw, 1);
  document.getElementById(`${prefix}_RH`).textContent = fmt(P.RH, 1);
  document.getElementById(`${prefix}_x`).textContent  = fmt(P.x*1000.0, 1);
  document.getElementById(`${prefix}_Td`).textContent = fmt(P.Td, 1);
  document.getElementById(`${prefix}_pv`).textContent = fmt(P.pv, 0);
  document.getElementById(`${prefix}_v`).textContent  = fmt(P.v, 4);
  document.getElementById(`${prefix}_h`).textContent  = fmt(P.h, 1);
  document.getElementById(`${prefix}_mu`).textContent = fmt(P.mu, 1);
  document.getElementById(`${prefix}_DI`).textContent = fmt(P.DI, 1);
}

/* ---- メイン計算 ---- */
function compute(){
  const msg = document.getElementById("msg");
  const outWrap = document.getElementById("results");
  msg.textContent = "";
  outWrap.style.display = "none";

  let T_in  = fnum(document.getElementById("T_in").value);
  let RH_in = fnum(document.getElementById("RH_in").value);
  let T_o   = fnum(document.getElementById("T_out").value);
  let RH_o  = fnum(document.getElementById("RH_out").value);
  let V_in  = fnum(document.getElementById("V").value); // m^3/min
  let Q_in  = fnum(document.getElementById("Q").value); // kW

  const fields = {T_in, RH_in, T_out:T_o, RH_out:RH_o, V:V_in, Q:Q_in};
  const missing = Object.keys(fields).filter(k => fields[k]==null);
  let solvedNote = "";

  /* ---- 5/6なら未知1個を解く ---- */
  if (missing.length === 1){
    const miss = missing[0];

    // 入口・出口の既知側を用意（未知側は後で関数で与える）
    const IN_known  = (T_in!=null && RH_in!=null) ? airProps(T_in, RH_in) : null;
    const OUT_known = (T_o !=null && RH_o !=null) ? airProps(T_o , RH_o ) : null;

    // (1) V or Q が未知（もう一方とIN/OUTが既知なら代数でOK）
    if (miss==="V" && Q_in!=null && IN_known && OUT_known){
      const dH = (IN_known.h - OUT_known.h);
      if (Math.abs(dH)>1e-12){
        const m_dot = Q_in / dH;
        V_in = m_dot * 60.0 * IN_known.v;
        document.getElementById("V").value = String(V_in);
        solvedNote += `未入力を計算: V = ${fmt(V_in,1)} m³/min\n`;
      }
    } else if (miss==="Q" && V_in!=null && IN_known && OUT_known){
      const m_dot = (V_in/60.0)/IN_known.v;
      Q_in = m_dot * (IN_known.h - OUT_known.h);
      document.getElementById("Q").value = String(Q_in);
      solvedNote += `未入力を計算: Q = ${fmt(Q_in,1)} kW\n`;
    }

    // (2) T_in / RH_in を解く（V & Q 必須、OUT既知）
    else if ((miss==="T_in"||miss==="RH_in") && V_in!=null && Q_in!=null && OUT_known){
      if (miss==="T_in" && RH_in!=null){
        const f = (Tin)=>{
          const IN = airProps(Tin, RH_in); if(!IN) return NaN;
          const m_dot = (V_in/60.0)/IN.v;
          return Q_in - m_dot*(IN.h - OUT_known.h);
        };
        const root = solve_bisect(f, -30, 60);
        if (root!=null){ T_in=root; document.getElementById("T_in").value=String(T_in); solvedNote += `未入力を計算: T_in = ${fmt(T_in,1)} °C\n`; }
      } else if (miss==="RH_in" && T_in!=null){
        const f = (rh)=>{
          const RH = Math.max(1, Math.min(99, rh));
          const IN = airProps(T_in, RH); if(!IN) return NaN;
          const m_dot = (V_in/60.0)/IN.v;
          return Q_in - m_dot*(IN.h - OUT_known.h);
        };
        const root = solve_bisect(f, 1, 99);
        if (root!=null){ RH_in=root; document.getElementById("RH_in").value=String(RH_in); solvedNote += `未入力を計算: RH_in = ${fmt(RH_in,1)} %\n`; }
      }
    }

    // (3) T_out / RH_out を解く（V & Q 必須、IN既知）
    else if ((miss==="T_out"||miss==="RH_out") && V_in!=null && Q_in!=null && IN_known){
      if (miss==="T_out" && RH_o!=null){
        const f = (Tout)=>{
          const OUT = airProps(Tout, RH_o); if(!OUT) return NaN;
          const m_dot = (V_in/60.0)/IN_known.v;
          return Q_in - m_dot*(IN_known.h - OUT.h);
        };
        const root = solve_bisect(f, -30, 40);
        if (root!=null){ T_o=root; document.getElementById("T_out").value=String(T_o); solvedNote += `未入力を計算: T_out = ${fmt(T_o,1)} °C\n`; }
      } else if (miss==="RH_out" && T_o!=null){
        const f = (rh)=>{
          const RH = Math.max(1, Math.min(99, rh));
          const OUT = airProps(T_o, RH); if(!OUT) return NaN;
          const m_dot = (V_in/60.0)/IN_known.v;
          return Q_in - m_dot*(IN_known.h - OUT.h);
        };
        const root = solve_bisect(f, 1, 99);
        if (root!=null){ RH_o=root; document.getElementById("RH_out").value=String(RH_o); solvedNote += `未入力を計算: RH_out = ${fmt(RH_o,1)} %\n`; }
      }
    }
    // それ以外（方程式不足など）は「解こうとせず」そのまま進む（＝エラーは出さない）
  }

  // ---- 最終プロップ計算（可能な範囲だけ） ----
  const IN  = (T_in!=null && RH_in!=null) ? airProps(T_in, RH_in) : null;
  const OUT = (T_o !=null && RH_o !=null) ? airProps(T_o , RH_o ) : null;

  let m_dot=null, V_val=null, Q_val=null, L_Lph=null;
  if (IN && OUT){
    if (V_in!=null){
      m_dot = (V_in/60.0)/IN.v;
      V_val = V_in;
      Q_val = m_dot*(IN.h - OUT.h);
    }
    if (V_in==null && Q_in!=null){
      const dH = IN.h - OUT.h;
      if (Math.abs(dH)>1e-12){
        m_dot = Q_in/dH;
        V_val = m_dot*60.0*IN.v;
        Q_val = Q_in;
      } else {
        Q_val = Q_in;
      }
    }
    if (m_dot!=null){
      L_Lph = (IN.x - OUT.x) * m_dot * 3600.0;
    }
  } else {
    // 片側だけでも詳細は表示可
  }

  // 主結果
  document.getElementById("rV").textContent = (V_val!=null)? fmt(V_val,1) : "-";
  document.getElementById("rQ").textContent = (Q_val!=null)? fmt(Q_val,1) : (Q_in!=null? fmt(Q_in,1): "-");
  document.getElementById("rL").textContent = (L_Lph!=null)? fmt(L_Lph,1) : "-";
  document.getElementById("rm").textContent = (m_dot!=null)? fmt(m_dot,4) : "-";

  // 詳細
  fillState("in", IN);
  fillState("out", OUT);

  // 表示切替＆メッセージ
  document.getElementById("results").style.display = (IN||OUT)? "block":"none";
  msg.textContent = solvedNote || "入力された範囲で計算しました。";
}

/* クリア */
function clearAll(){
  ["T_in","RH_in","T_out","RH_out","V","Q"].forEach(id => document.getElementById(id).value = "");
  ["rV","rQ","rL","rm","in_T","in_Tw","in_RH","in_x","in_Td","in_pv","in_v","in_h","in_mu","in_DI",
   "out_T","out_Tw","out_RH","out_x","out_Td","out_pv","out_v","out_h","out_mu","out_DI"]
   .forEach(id => document.getElementById(id).textContent = "-");
  const msg = document.getElementById("msg");
  msg.textContent = "";
  document.getElementById("results").style.display = "none";
}

/* イベント */
document.getElementById("calc").addEventListener("click", compute);
document.getElementById("clear").addEventListener("click", clearAll);
</script>
</body>
</html>
