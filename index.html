<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>除湿能力 計算（軽量HTML版）</title>
  <!-- PyScript（Pyodide同梱）※追加パッケージは読み込みません -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <style>
    :root { --pad:14px; }
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
         padding:16px; max-width:820px; margin:auto; line-height:1.6}
    h1{font-size:1.15rem; margin:2px 0 10px}
    .card{border:1px solid #e5e7eb; border-radius:12px; padding:var(--pad); margin:12px 0; box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .row{display:grid; grid-template-columns:8.5em 1fr 6.5em; gap:8px; align-items:center; margin:8px 0}
    label{font-size:0.95rem}
    input{width:100%; padding:12px; font-size:18px; border:1px solid #d1d5db; border-radius:10px}
    input:focus{outline:none; border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    button{width:100%; padding:14px; font-size:18px; border-radius:12px; border:0; background:#0ea5e9; color:#fff}
    button:active{transform:translateY(1px)}
    .muted{color:#6b7280; font-size:0.95rem}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .ok{color:#059669}.err{color:#dc2626}
    @media (max-width:480px){ .row{grid-template-columns:7.5em 1fr 5.5em} }
  </style>
</head>
<body>
  <h1>除湿能力 計算（HTML/ブラウザ実行・軽量版）</h1>

  <div class="card">
    <div class="row">
      <label>吸込温度</label>
      <input id="T_in" type="number" step="0.1" inputmode="decimal" placeholder="例) 27">
      <span>°C(DB)</span>
    </div>
    <div class="row">
      <label>吸込湿度</label>
      <input id="RH_in" type="number" step="0.1" inputmode="decimal" placeholder="例) 50">
      <span>%RH</span>
    </div>
    <div class="row">
      <label>冷却温度</label>
      <input id="T_out" type="number" step="0.1" inputmode="decimal" placeholder="例) 15">
      <span>°C(DB)</span>
    </div>
    <div class="row">
      <label>冷却湿度</label>
      <input id="RH_out" type="number" step="0.1" inputmode="decimal" placeholder="例) 90">
      <span>%RH</span>
    </div>
    <div class="row">
      <label>風量（任意）</label>
      <input id="V" type="number" step="0.1" inputmode="decimal" placeholder="例) 30">
      <span>m³/min</span>
    </div>
    <div class="row">
      <label>冷却能力（任意）</label>
      <input id="Q" type="number" step="0.1" inputmode="decimal" placeholder="未入力なら自動計算">
      <span>kW</span>
    </div>
    <div class="muted">※ 必須：吸込T/φ・冷却T/φ と「VまたはQのどちらか」</div>
    <div style="margin-top:12px"><button id="calc">計算</button></div>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </div>

  <div id="results" class="card" style="display:none">
    <div class="grid2 mono">
      <div>風量 V: <span id="rV"></span> m³/min</div>
      <div>冷却能力 Q: <span id="rQ"></span> kW</div>
      <div>除湿量 L: <span id="rL"></span> L/h</div>
      <div>質量流量 ṁ: <span id="rm"></span> kg/s</div>
    </div>
    <div class="muted" style="margin-top:8px">
      ※ BF・混合・再熱は未対応（軽量化のため）。必要になったら足せます。
    </div>
  </div>

  <!-- 追加パッケージなし -->
  <py-config></py-config>

  <py-script>
from js import document
import math

# 定数（kJ系に統一）
P_ATM = 101.325   # kPa
R_AIR = 0.287     # kJ/(kg·K)
C_A   = 1.006     # kJ/(kg·K)
C_W   = 1.86      # kJ/(kg·K)
H_W   = 2501.0    # kJ/kg

def ps(T_c):
    # Tetens式近似（kPa）
    return 0.61078 * math.exp((17.27 * T_c) / (T_c + 237.3))

def x_from_phi(phi, T_c):
    # phi: 相対湿度(0-1), x: kg/kg(DA)
    pv = phi * ps(T_c)
    return 0.622 * pv / (P_ATM - pv)

def h_moist_air(T_c, x):
    # 比エンタルピ kJ/kg(DA)
    return C_A*T_c + x * (H_W + C_W*T_c)

def v_specific(T_c, x):
    # 比容 m^3/kg(DA)
    return (R_AIR * (T_c + 273.15) / P_ATM) * (1.0 + 1.6078 * x)

def safe_float(s):
    try:
        return float(s)
    except:
        return None

def compute(event=None):
    msg = document.getElementById("msg")
    out = document.getElementById("results")
    msg.innerHTML = ""
    out.style.display = "none"

    T_in  = safe_float(document.getElementById("T_in").value)
    RH_in = safe_float(document.getElementById("RH_in").value)
    T_o   = safe_float(document.getElementById("T_out").value)
    RH_o  = safe_float(document.getElementById("RH_out").value)
    V_in  = safe_float(document.getElementById("V").value)  # m^3/min  | optional
    Q_in  = safe_float(document.getElementById("Q").value)  # kW       | optional

    # 必須チェック
    if None in (T_in, RH_in, T_o, RH_o):
        msg.innerHTML = "<span class='err'>吸込T/φ・冷却T/φは必須です。</span>"
        return
    if (V_in is None) and (Q_in is None):
        msg.innerHTML = "<span class='err'>風量 V または 冷却能力 Q のどちらかを入力してください。</span>"
        return

    # 吸込状態
    phi_in = RH_in / 100.0
    x_in   = x_from_phi(phi_in, T_in)
    h_in   = h_moist_air(T_in, x_in)
    v_in   = v_specific(T_in, x_in)

    # 冷却後状態
    phi_o = RH_o / 100.0
    x_o   = x_from_phi(phi_o, T_o)
    h_o   = h_moist_air(T_o, x_o)

    # 質量流量・Q・V の相互計算
    m_dot = None
    Q_val = Q_in
    V_val = V_in

    # Vがあるなら m_dot を先に確定
    if V_val is not None:
        m_dot = (V_val / 60.0) / v_in  # kg/s

    # Qが無ければ計算
    if Q_val is None:
        if m_dot is None:
            msg.innerHTML = "<span class='err'>内部エラー: m_dot未定義</span>"
            return
        Q_val = m_dot * (h_in - h_o)  # kW

    # Vが無ければ Q から逆算
    if V_val is None:
        # Q = m_dot*(h_in - h_o) → m_dot = Q / Δh
        delta_h = (h_in - h_o)
        if abs(delta_h) < 1e-9:
            msg.innerHTML = "<span class='err'>状態が等しいため V を逆算できません（Δh≈0）。</span>"
            return
        m_dot = Q_val / delta_h
        V_val = m_dot * 60.0 * v_in

    # 除湿量 L/h
    L_Lph = (x_in - x_o) * m_dot * 3600.0  # kg/h ≒ L/h

    # 表示
    def fmt(x, n=1):
        try:
            return f"{x:.{n}f}"
        except:
            return "-"

    document.getElementById("rV").innerText = fmt(V_val, 1)
    document.getElementById("rQ").innerText = fmt(Q_val, 1)
    document.getElementById("rL").innerText = fmt(L_Lph, 1)
    document.getElementById("rm").innerText = fmt(m_dot, 4)
    out.style.display = "block"
    msg.innerHTML = "<span class='ok'>計算しました。</span>"

document.getElementById("calc").addEventListener("click", compute)
  </py-script>
</body>
</html>
