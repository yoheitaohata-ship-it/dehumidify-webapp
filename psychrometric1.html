<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>心理線図ツール（HTML版）</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: "Yu Gothic", "Meiryo", sans-serif; margin: 0; }
    header { background:#f5f5f5; padding:10px 20px; border-bottom:1px solid #ddd; }
    h1 { margin:0; font-size:20px; }
    .container { display:grid; grid-template-columns:340px 1fr; gap:10px; padding:10px 20px; }
    .panel { border:1px solid #ddd; border-radius:6px; padding:10px; margin-bottom:10px; }
    .panel h2 { margin-top:0; font-size:16px; border-bottom:1px solid #eee; padding-bottom:4px; }
    .row { margin-bottom:6px; }
    label { display:inline-block; width:130px; }
    input[type="number"] { width:120px; }
    button { padding:4px 12px; margin-right:4px; cursor:pointer; }
    .btn-primary { background:#ffb6c1; border:1px solid #ff9ab0; }
    pre { background:#fafafa; border:1px solid #eee; padding:6px; white-space:pre-wrap; }
  </style>
</head>
<body>

<header>
  <h1>心理線図ツール（HTML + JavaScript）</h1>
</header>

<div class="container">

  <!-- 左側：入力欄だけ最初表示 -->
  <div>
    <div class="panel">
      <h2>吸込 空気条件</h2>
      <div class="row">
        <label for="Tin">温度 T_in[℃]</label>
        <input type="number" id="Tin" step="0.1">
      </div>
      <div class="row">
        <label for="phi_in">相対湿度 φ_in[%]</label>
        <input type="number" id="phi_in" step="0.1">
      </div>
    </div>

    <div class="panel">
      <h2>冷却後 空気条件</h2>
      <div class="row">
        <label for="Tout">温度 T_out[℃]</label>
        <input type="number" id="Tout" step="0.1">
      </div>
      <div class="row">
        <label for="phi_out">相対湿度 φ_out[%]</label>
        <input type="number" id="phi_out" step="0.1">
      </div>
    </div>

    <div class="panel">
      <h2>風量（任意）</h2>
      <div class="row">
        <label for="V">V[m³/min]</label>
        <input type="number" id="V" step="0.1">
      </div>
    </div>

    <div class="panel">
      <button class="btn-primary" onclick="onPlot()">プロット</button>
      <button onclick="onClear()">クリア</button>
      <div id="status"></div>
    </div>

    <div class="panel">
      <h2>空気情報</h2>
      <strong>吸込</strong>
      <pre id="info_in">未計算</pre>

      <strong>冷却</strong>
      <pre id="info_out">未計算</pre>

      <strong>プロセス</strong>
      <pre id="info_proc">未計算</pre>
    </div>
  </div>

  <!-- 右側：最初は完全に非表示 -->
  <div id="graph-panel" style="display:none;">
    <div class="panel">
      <h2>心理線図</h2>
      <div id="graph" style="width:100%;height:480px;"></div>
    </div>
  </div>

</div>


<script>
/* ---------- JS 計算ロジック（省略せずにそのまま移植） ---------- */
// 大気圧など定数
const P_ATM = 101.325;
const CA = 1.005;
const CW = 4.186;
const HW = 2500.0;

function ps(T){ return 0.61078*Math.exp(17.27*T/(T+237.3)); }
function calcX(phi,T){
  const pws=ps(T); const pw=phi*pws;
  return 0.622*pw/Math.max(P_ATM-pw,1e-6);
}
function calcH(T,x){ return CA*T + x*(HW + CW*T); }
function calcV(T,x){ const R=0.287; return (R*(T+273.15)/P_ATM)*(1+1.6078*x); }

function linspace(a,b,n){
  let arr=[]; let d=(b-a)/(n-1);
  for(let i=0;i<n;i++)arr.push(a+d*i);
  return arr;
}

/* ---------- グラフ描画 ---------- */
function drawChart(Tmin,Tmax,Tin,phi_in,Tout,phi_out){
  let T=linspace(Tmin,Tmax,300);
  let sat=T.map(t=>calcX(1,t));

  let traces=[{
    x:T, y:sat, mode:"lines",
    name:"100%RH", line:{color:"black"}
  }];

  for(let rh=10; rh<100; rh+=10){
    let xs=T.map(t=>calcX(rh/100,t));
    traces.push({
      x:T, y:xs, mode:"lines",
      name:`${rh}%`, line:{color:"gray"}, opacity:0.6,
      showlegend:(rh===10)
    });
  }

  let x_in=null, x_out=null;

  if(Tin!=null && phi_in!=null){
    x_in = calcX(phi_in/100,Tin);
    traces.push({
      x:[Tin], y:[x_in],
      mode:"markers+text",
      text:["吸込"], textposition:"top right",
      marker:{color:"blue",size:8}
    });
  }

  if(Tout!=null && phi_out!=null){
    x_out = calcX(phi_out/100,Tout);
    traces.push({
      x:[Tout], y:[x_out],
      mode:"markers+text",
      text:["冷却"], textposition:"bottom right",
      marker:{color:"red",size:8}
    });
  }

  if(x_in!=null && x_out!=null){
    traces.push({
      x:[Tin,Tout], y:[x_in,x_out],
      mode:"lines", line:{color:"purple",dash:"dash"}
    });
  }

  Plotly.newPlot("graph", traces, {
    xaxis:{title:"温度[℃]"},
    yaxis:{title:"絶対湿度[kg/kg(DA)]"},
    margin:{l:60,r:20,t:30,b:50}
  });
}

/* ---------- ボタン処理 ---------- */
function n(id){
  let v=document.getElementById(id).value;
  return v===""?null:Number(v);
}

function onPlot(){
  let Tin=n("Tin"), phi_in=n("phi_in");
  let Tout=n("Tout"), phi_out=n("phi_out");
  let V=n("V");

  // ★ グラフパネルをここで初めて表示
  document.getElementById("graph-panel").style.display="block";

  let Ts=[];
  if(Tin!=null)Ts.push(Tin);
  if(Tout!=null)Ts.push(Tout);

  let Tmin= -50, Tmax=-30;
  if(Ts.length>0){
    Tmin=Math.min(...Ts)-5;
    Tmax=Math.max(...Ts)+5;
  }

  drawChart(Tmin,Tmax,Tin,phi_in,Tout,phi_out);

  // 空気情報
  let info_in="未入力", info_out="未入力";
  if(Tin!=null && phi_in!=null){
    let x=calcX(phi_in/100,Tin);
    let h=calcH(Tin,x);
    let v=calcV(Tin,x);
    info_in=`T=${Tin}℃\nφ=${phi_in}%\nx=${x}\nh=${h}kJ/kg\nv=${v}`;
  }
  if(Tout!=null && phi_out!=null){
    let x=calcX(phi_out/100,Tout);
    let h=calcH(Tout,x);
    let v=calcV(Tout,x);
    info_out=`T=${Tout}℃\nφ=${phi_out}%\nx=${x}\nh=${h}kJ/kg\nv=${v}`;
  }

  document.getElementById("info_in").textContent=info_in;
  document.getElementById("info_out").textContent=info_out;

  // プロセス
  let proc="未計算";
  if(Tin!=null && phi_in!=null && Tout!=null && phi_out!=null){
    let x1=calcX(phi_in/100,Tin);
    let x2=calcX(phi_out/100,Tout);
    let h1=calcH(Tin,x1);
    let h2=calcH(Tout,x2);
    let dh=h1-h2;

    proc=`Δh = ${dh.toFixed(2)} kJ/kg`;

    if(V!=null){
      let v1=calcV(Tin,x1);
      let m= (V/60)/v1;
      let Q = m*dh;
      proc += `\n冷凍能力 ≈ ${Q.toFixed(2)} kW`;
    }
  }

  document.getElementById("info_proc").textContent=proc;
  document.getElementById("status").textContent="プロットしました";
}

function onClear(){
  ["Tin","phi_in","Tout","phi_out","V"].forEach(id=>document.getElementById(id).value="");

  document.getElementById("info_in").textContent="未計算";
  document.getElementById("info_out").textContent="未計算";
  document.getElementById("info_proc").textContent="未計算";
  document.getElementById("status").textContent="クリアしました";

  // ★ グラフパネルを非表示に戻す
  Plotly.purge("graph");
  document.getElementById("graph-panel").style.display="none";
}

</script>

</body>
</html>
