<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>心理線図ツール（HTML版・試作）</title>
  <!-- Plotly.js CDN -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body {
      font-family: "Yu Gothic", "Meiryo", sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background: #f5f5f5;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    .container {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 10px;
      padding: 10px 20px 20px;
    }
    .panel {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .panel h2 {
      margin-top: 0;
      font-size: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }
    label {
      display: inline-block;
      width: 130px;
      font-size: 13px;
    }
    input[type="number"] {
      width: 120px;
      padding: 2px 4px;
      font-size: 13px;
    }
    .row {
      margin-bottom: 6px;
    }
    button {
      padding: 4px 12px;
      margin-right: 4px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-primary {
      background: #ffb6c1;
      border: 1px solid #ff9ab0;
    }
    .btn-secondary {
      background: #f0f0f0;
      border: 1px solid #ccc;
    }
    #status {
      color: #c00;
      font-size: 12px;
      margin-top: 6px;
    }
    pre {
      background: #fafafa;
      border: 1px solid #eee;
      padding: 6px;
      font-size: 12px;
      white-space: pre-wrap;
    }
    #graph-placeholder {
      font-size: 13px;
      color: #666;
      text-align: center;
      padding: 40px 10px;
    }
  </style>
</head>
<body>
<header>
  <h1>心理線図ツール（HTML + JavaScript 版・試作）</h1>
</header>

<div class="container">
  <!-- 左側：入力パネル -->
  <div>
    <div class="panel">
      <h2>吸込 空気条件</h2>
      <div class="row">
        <label for="Tin">温度 T_in [℃]</label>
        <input type="number" id="Tin" step="0.1" placeholder="例: 5">
      </div>
      <div class="row">
        <label for="phi_in">相対湿度 φ_in [%]</label>
        <input type="number" id="phi_in" step="0.1" placeholder="例: 80">
      </div>
    </div>

    <div class="panel">
      <h2>冷却後 空気条件</h2>
      <div class="row">
        <label for="Tout">温度 T_out [℃]</label>
        <input type="number" id="Tout" step="0.1" placeholder="例: -10">
      </div>
      <div class="row">
        <label for="phi_out">相対湿度 φ_out [%]</label>
        <input type="number" id="phi_out" step="0.1" placeholder="例: 95">
      </div>
    </div>

    <div class="panel">
      <h2>風量・冷凍能力</h2>
      <div class="row">
        <label for="V">風量 V [m³/min]</label>
        <input type="number" id="V" step="0.1" placeholder="任意">
      </div>
    </div>

    <div class="panel">
      <button class="btn-primary" onclick="onPlot()">プロット</button>
      <button class="btn-secondary" onclick="onClear()">クリア</button>
      <div id="status"></div>
    </div>

    <div class="panel">
      <h2>空気情報</h2>
      <strong>吸込</strong>
      <pre id="info_in">未計算</pre>
      <strong>冷却</strong>
      <pre id="info_out">未計算</pre>

      <strong>プロセス</strong>
      <pre id="info_proc">未計算</pre>
    </div>
  </div>

  <!-- 右側：グラフ -->
  <div class="panel">
    <h2>心理線図</h2>
    <!-- 最初はプレースホルダだけ表示 -->
    <div id="graph-placeholder">
      「プロット」ボタンを押すと、ここに心理線図が表示されます。
    </div>
    <!-- グラフ本体は最初は非表示 -->
    <div id="graph" style="width:100%;height:480px;display:none;"></div>
  </div>
</div>

<script>
// ==============================
// 物性・計算ロジック (JS版)
// ==============================
const P_ATM = 101.325; // kPa
const CA = 1.005;      // kJ/kgK
const CW = 4.186;      // kJ/kgK
const HW = 2500.0;     // kJ/kg

function ps(Tc) {
  // 飽和水蒸気圧 [kPa] Tetens近似
  return 0.61078 * Math.exp(17.27 * Tc / (Tc + 237.3));
}

function calcX(phi, Tc, mode="relative") {
  // 絶対湿度 x [kg/kg(DA)]
  if (mode === "absolute") {
    return Number(phi);
  }
  const pws = ps(Tc);
  const pw  = phi * pws;
  return 0.622 * pw / Math.max(P_ATM - pw, 1e-6);
}

function calcH(Tc, x) {
  // 比エンタルピ h [kJ/kg(DA)]
  return CA * Tc + x * (HW + CW * Tc);
}

function calcV(Tc, x) {
  // 比容積 v [m³/kg(DA)]
  const R = 0.287;
  const Tk = Tc + 273.15;
  return (R * Tk / P_ATM) * (1.0 + 1.6078 * x);
}

function calcDewPoint(phiRatio, Tc) {
  // 露点温度 [℃]
  let r = Math.min(Math.max(phiRatio, 1e-6), 1.0);
  const a = 17.27;
  const b = 237.3;
  const gamma = Math.log(r) + a * Tc / (b + Tc);
  return b * gamma / (a - gamma);
}

function calcSaturationDegree(Tc, x) {
  // 飽和度 μ[%] = x/xs * 100
  const xs = calcX(1.0, Tc, "relative");
  if (xs <= 0) return 0.0;
  return x / xs * 100.0;
}

function linspace(a, b, n) {
  const arr = [];
  if (n === 1) {
    arr.push(a);
    return arr;
  }
  const step = (b - a) / (n - 1);
  for (let i = 0; i < n; i++) {
    arr.push(a + step * i);
  }
  return arr;
}

function buildAirInfoText(Tc, phiPercent) {
  if (Tc === null || phiPercent === null || isNaN(Tc) || isNaN(phiPercent)) {
    return "未入力";
  }
  const phiRatio = phiPercent / 100.0;
  const x = calcX(phiRatio, Tc, "relative");
  const h = calcH(Tc, x);
  const v = calcV(Tc, x);
  const Td = calcDewPoint(phiRatio, Tc);
  const pv = phiRatio * ps(Tc) * 1000.0; // Pa
  const mu = calcSaturationDegree(Tc, x);

  return (
    `T = ${Tc.toFixed(1)} ℃\n` +
    `φ = ${phiPercent.toFixed(1)} %\n` +
    `x = ${x.toFixed(7)} kg/kg(DA)\n` +
    `h = ${h.toFixed(2)} kJ/kg(DA)\n` +
    `v = ${v.toFixed(4)} m³/kg(DA)\n` +
    `露点温度 = ${Td.toFixed(1)} ℃\n` +
    `水蒸気分圧 = ${pv.toFixed(0)} Pa\n` +
    `飽和度 = ${mu.toFixed(1)} %`
  );
}

// ==============================
// グラフ描画
// ==============================
function drawPsychChart(Tmin, Tmax, T_in, phi_in, T_out, phi_out) {
  // 温度範囲調整
  let T1 = Math.min(Tmin, Tmax);
  let T2 = Math.max(Tmin, Tmax);
  T1 = Math.max(-60, T1);
  T2 = Math.min(60, T2);

  const T = linspace(T1, T2, 400);
  const xSat = T.map(t => calcX(1.0, t, "relative"));
  const xMax = Math.max.apply(null, xSat);
  const yMax = xMax * 1.05;

  // 飽和線
  const traces = [];
  traces.push({
    x: T,
    y: xSat,
    mode: "lines",
    name: "100%RH",
    line: {color: "black", width: 2}
  });

  // 10〜90%RH
  for (let rh = 10; rh < 100; rh += 10) {
    const phi = rh / 100.0;
    const xs = T.map(t => calcX(phi, t, "relative"));
    traces.push({
      x: T,
      y: xs,
      mode: "lines",
      name: `${rh}%RH`,
      line: {color: "gray", width: 1},
      opacity: 0.7,
      showlegend: (rh === 10)
    });
  }

  // 吸込点
  let x_in = null;
  let x_out = null;
  if (T_in !== null && phi_in !== null && !isNaN(T_in) && !isNaN(phi_in)) {
    const phiRatioIn = phi_in / 100.0;
    x_in = calcX(phiRatioIn, T_in, "relative");
    traces.push({
      x: [T_in],
      y: [x_in],
      mode: "markers+text",
      name: "吸込",
      text: ["吸込"],
      textposition: "top right",
      marker: {color: "blue", size: 8}
    });
  }

  // 冷却点
  if (T_out !== null && phi_out !== null && !isNaN(T_out) && !isNaN(phi_out)) {
    const phiRatioOut = phi_out / 100.0;
    x_out = calcX(phiRatioOut, T_out, "relative");
    traces.push({
      x: [T_out],
      y: [x_out],
      mode: "markers+text",
      name: "冷却",
      text: ["冷却"],
      textposition: "bottom right",
      marker: {color: "red", size: 8}
    });
  }

  // 結ぶ線
  if (x_in !== null && x_out !== null) {
    traces.push({
      x: [T_in, T_out],
      y: [x_in, x_out],
      mode: "lines",
      line: {color: "purple", width: 1, dash: "dash"},
      name: "プロセス"
    });
  }

  const layout = {
    xaxis: {title: "温度 T [℃]", range: [T1, T2]},
    yaxis: {title: "絶対湿度 x [kg/kg(DA)]", range: [0, yMax]},
    margin: {l: 60, r: 20, t: 40, b: 60},
    legend: {orientation: "h"}
  };

  Plotly.newPlot("graph", traces, layout, {responsive: true});
}

// ==============================
// イベント処理
// ==============================
function getInputNumber(id) {
  const val = document.getElementById(id).value;
  if (val === "" || val === null) return null;
  const num = Number(val);
  return isNaN(num) ? null : num;
}

function onPlot() {
  const T_in  = getInputNumber("Tin");
  const phi_in = getInputNumber("phi_in");
  const T_out = getInputNumber("Tout");
  const phi_out = getInputNumber("phi_out");
  const V_in  = getInputNumber("V");

  const statusEl = document.getElementById("status");
  const infoInEl = document.getElementById("info_in");
  const infoOutEl = document.getElementById("info_out");
  const infoProcEl = document.getElementById("info_proc");
  const graphDiv = document.getElementById("graph");
  const placeholder = document.getElementById("graph-placeholder");

  statusEl.textContent = "";

  // 初回プロット時にグラフを表示 & プレースホルダを消す
  placeholder.style.display = "none";
  graphDiv.style.display = "block";

  // 温度範囲決定
  const Ts = [];
  if (T_in !== null) Ts.push(T_in);
  if (T_out !== null) Ts.push(T_out);
  let T_min = -50.0, T_max = -30.0;
  if (Ts.length > 0) {
    const minT = Math.min.apply(null, Ts);
    const maxT = Math.max.apply(null, Ts);
    T_min = minT - 5.0;
    T_max = maxT + 5.0;
  }

  drawPsychChart(T_min, T_max, T_in, phi_in, T_out, phi_out);

  // 空気情報
  infoInEl.textContent  = buildAirInfoText(T_in,  phi_in);
  infoOutEl.textContent = buildAirInfoText(T_out, phi_out);

  // プロセス情報（Δh, 冷凍能力）
  let procLines = [];
  if (T_in !== null && phi_in !== null && T_out !== null && phi_out !== null) {
    const phiRatioIn = phi_in / 100.0;
    const x_in = calcX(phiRatioIn, T_in, "relative");
    const h_in = calcH(T_in, x_in);
    const v_in = calcV(T_in, x_in);

    const phiRatioOut = phi_out / 100.0;
    const x_out = calcX(phiRatioOut, T_out, "relative");
    const h_out = calcH(T_out, x_out);

    const delta_h = h_in - h_out;
    procLines.push(`エンタルピ差 Δh = ${delta_h.toFixed(2)} kJ/kg(DA)`);

    if (V_in !== null) {
      const V_s = V_in / 60.0;         // m³/min → m³/s
      const m_da = V_s / v_in;         // kg/s
      const Q_kW = m_da * delta_h;     // kW (kJ/s)
      const Q_kcal_h = Q_kW * 860.0;   // ≒ kcal/h

      procLines.push(`風量 V = ${V_in.toFixed(1)} m³/min のとき`);
      procLines.push(`  冷凍能力 ≒ ${Q_kW.toFixed(2)} kW (約 ${Q_kcal_h.toFixed(0)} kcal/h)`);
    } else {
      procLines.push("風量が未入力のため、冷凍能力は計算していません。");
    }
  } else {
    procLines.push("吸込・冷却の両方が入力されているときに、風量・冷凍能力の計算を行います。");
  }

  infoProcEl.textContent = procLines.join("\n");
  statusEl.textContent = "プロットしました。";
}

function onClear() {
  document.getElementById("Tin").value = "";
  document.getElementById("phi_in").value = "";
  document.getElementById("Tout").value = "";
  document.getElementById("phi_out").value = "";
  document.getElementById("V").value = "";

  document.getElementById("info_in").textContent = "未計算";
  document.getElementById("info_out").textContent = "未計算";
  document.getElementById("info_proc").textContent = "未計算";
  document.getElementById("status").textContent = "クリアしました。";

  // グラフを消して、プレースホルダを再表示
  const graphDiv = document.getElementById("graph");
  const placeholder = document.getElementById("graph-placeholder");
  Plotly.purge("graph");
  graphDiv.style.display = "none";
  placeholder.style.display = "block";
}
</script>
</body>
</html>
